version: "3.8"

networks:
  workadventure-net:
    driver: bridge

services:
  traefik:
    image: traefik:v2.10
    restart: always
    command:
      - "--providers.docker=true"
      - "--providers.docker.exposedbydefault=false"
      - "--entrypoints.web.address=:80"
      - "--entrypoints.web.http.redirections.entrypoint.to=websecure"
      - "--entrypoints.web.http.redirections.entrypoint.scheme=https"
      - "--entrypoints.websecure.address=:443"
      - "--certificatesresolvers.${TRAEFIK_CERT_RESOLVER}.acme.tlschallenge=true"
      - "--certificatesresolvers.${TRAEFIK_CERT_RESOLVER}.acme.email=${EMAIL}"
      - "--certificatesresolvers.${TRAEFIK_CERT_RESOLVER}.acme.storage=/letsencrypt/acme.json"
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./traefik/acme.json:/letsencrypt/acme.json
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - workadventure-net

  frontend:
    image: ghcr.io/thecodingmachine/workadventure-front:3.8.4
    restart: always
    env_file:
      - ./.env
    environment:
      DOMAIN: ${DOMAIN}
      ROOM_API_URL: /api
      PUSHER_URL: /pusher
      MAP_URL: ${MAPS_URL}
      SECRET_KEY: ${SECRET_KEY}
    depends_on:
      - back
      - pusher
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.frontend.rule=Host(`${TRAEFIK_HOST}`)"
      - "traefik.http.routers.frontend.entrypoints=websecure"
      - "traefik.http.routers.frontend.tls.certresolver=${TRAEFIK_CERT_RESOLVER}"
      - "traefik.http.services.frontend.loadbalancer.server.port=3000"
    networks:
      - workadventure-net

  pusher:
    image: ghcr.io/thecodingmachine/workadventure-pusher:3.8.4
    restart: always
    env_file:
      - ./.env
    environment:
      DOMAIN: ${DOMAIN}
      TURN_HOST: ${TURN_HOST}
      TURN_PORT: ${TURN_PORT}
      TURN_USER: ${TURN_USER}
      TURN_PASSWORD: ${TURN_PASSWORD}
      SECRET_KEY: ${SECRET_KEY}
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.pusher.rule=Host(`${TRAEFIK_HOST}`) && PathPrefix(`/pusher`)"
      - "traefik.http.routers.pusher.entrypoints=websecure"
      - "traefik.http.routers.pusher.tls.certresolver=${TRAEFIK_CERT_RESOLVER}"
      - "traefik.http.middlewares.pusher-stripprefix.stripprefix.prefixes=/pusher"
      - "traefik.http.routers.pusher.middlewares=pusher-stripprefix"
      - "traefik.http.services.pusher.loadbalancer.server.port=8080"
    networks:
      - workadventure-net

  back:
    image: ghcr.io/thecodingmachine/workadventure-back:latest
    restart: always
    env_file:
      - ./.env
    environment:
      DOMAIN: ${DOMAIN}
      SECRET_KEY: ${SECRET_KEY}
      PUSHER_URL: http://pusher:8080
      MAP_STORAGE_URL: http://maps:80/maps
    depends_on:
      - pusher
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.back.rule=Host(`${TRAEFIK_HOST}`) && PathPrefix(`/api`)"
      - "traefik.http.routers.back.entrypoints=websecure"
      - "traefik.http.routers.back.tls.certresolver=${TRAEFIK_CERT_RESOLVER}"
      - "traefik.http.middlewares.back-stripprefix.stripprefix.prefixes=/api"
      - "traefik.http.routers.back.middlewares=back-stripprefix"
      - "traefik.http.services.back.loadbalancer.server.port=8080"
    networks:
      - workadventure-net

  admin:
    image: ghcr.io/thecodingmachine/workadventure-admin-back:latest
    restart: always
    env_file:
      - ./.env
    environment:
      DOMAIN: ${DOMAIN}
      SECRET_KEY: ${SECRET_KEY}
      BACK_URL: http://back:8080
    depends_on:
      - back
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.admin.rule=Host(`${ADMIN_DOMAIN}`)"
      - "traefik.http.routers.admin.entrypoints=websecure"
      - "traefik.http.routers.admin.tls.certresolver=${TRAEFIK_CERT_RESOLVER}"
      - "traefik.http.services.admin.loadbalancer.server.port=8080"
    networks:
      - workadventure-net

  maps:
    image: nginx:alpine
    restart: always
    volumes:
      - ./maps:/usr/share/nginx/html/maps
      - ./maps.nginx.conf:/etc/nginx/conf.d/default.conf
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.maps.rule=Host(`${TRAEFIK_HOST}`) && PathPrefix(`/maps`)"
      - "traefik.http.routers.maps.entrypoints=websecure"
      - "traefik.http.routers.maps.tls.certresolver=${TRAEFIK_CERT_RESOLVER}"
      - "traefik.http.routers.maps.priority=10"
      - "traefik.http.services.maps.loadbalancer.server.port=80"
    networks:
      - workadventure-net

  coturn:
    image: instrumentisto/coturn:latest
    restart: always
    command:
      - --lt-cred-mech
      - --fingerprint
      - --realm=${DOMAIN}
      - --user=${TURN_USER}:${TURN_PASSWORD}
      - --listening-port=${TURN_PORT}
      - --no-tls
      - --no-dtls
    ports:
      - "${TURN_PORT}:${TURN_PORT}/udp"
      - "${TURN_PORT}:${TURN_PORT}/tcp"
    networks:
      - workadventure-net
