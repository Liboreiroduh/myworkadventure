version: "3.8"

networks:
  workadventure-net:
    driver: bridge

services:
  play:
    image: ghcr.io/workadventure/play:latest
    restart: always
    env_file:
      - .env
    environment:
      DOMAIN: ${DOMAIN}
      ROOM_API_URL: /api
      PUSHER_URL: /pusher
      MAP_URL: /maps
      SECRET_KEY: ${SECRET_KEY}
    depends_on:
      - pusher
      - room-api
      - map-storage
    networks:
      - workadventure-net

  pusher:
    image: ghcr.io/workadventure/pusher:latest
    restart: always
    env_file:
      - .env
    environment:
      DOMAIN: ${DOMAIN}
      TURN_HOST: ${TURN_HOST}
      TURN_PORT: ${TURN_PORT}
      TURN_USER: ${TURN_USER}
      TURN_PASSWORD: ${TURN_PASSWORD}
      SECRET_KEY: ${SECRET_KEY}
    networks:
      - workadventure-net

  room-api:
    image: ghcr.io/workadventure/room-api:latest
    restart: always
    env_file:
      - .env
    environment:
      DOMAIN: ${DOMAIN}
      SECRET_KEY: ${SECRET_KEY}
      PUSHER_URL: http://pusher:8080
      MAP_STORAGE_URL: http://map-storage:80
    depends_on:
      - pusher
    networks:
      - workadventure-net

  map-storage:
    image: ghcr.io/workadventure/map-storage:latest
    restart: always
    env_file:
      - .env
    environment:
      BASE_URL: /maps
    volumes:
      - ../../docker-data/map-storage:/var/www/html/maps
    networks:
      - workadventure-net

  coturn:
    image: instrumentisto/coturn:latest
    restart: always
    command:
      - --lt-cred-mech
      - --fingerprint
      - --realm=${DOMAIN}
      - --user=${TURN_USER}:${TURN_PASSWORD}
      - --listening-port=${TURN_PORT}
      - --no-tls
      - --no-dtls
    ports:
      - "${TURN_PORT}:${TURN_PORT}/udp"
      - "${TURN_PORT}:${TURN_PORT}/tcp"
    networks:
      - workadventure-net

  nginx:
    image: nginx:1.25-alpine
    restart: always
    depends_on:
      - play
      - pusher
      - room-api
      - map-storage
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ../../docker-data/nginx/logs:/var/log/nginx
    networks:
      - workadventure-net

