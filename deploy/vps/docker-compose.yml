version: "3.8"

services:
  play:
    image: thecodingmachine/workadventure-play:latest
    restart: always
    env_file:
      - .env
    environment:
      DOMAIN: ${DOMAIN}
      ROOM_API_URL: ${API_URL}
      PUSHER_URL: ${PUSHER_URL}
      MAP_URL: ${MAP_URL}
      SECRET_KEY: ${SECRET_KEY}
    depends_on:
      - pusher
      - room-api
      - map-storage
    networks:
      - workadventure-net

  pusher:
    image: thecodingmachine/workadventure-pusher:latest
    restart: always
    env_file:
      - .env
    environment:
      DOMAIN: ${DOMAIN}
      TURN_HOST: ${TURN_HOST}
      TURN_PORT: ${TURN_PORT}
      TURN_USER: ${TURN_USER}
      TURN_PASSWORD: ${TURN_PASSWORD}
      SECRET_KEY: ${SECRET_KEY}
    depends_on:
      - coturn
    networks:
      - workadventure-net

  room-api:
    image: thecodingmachine/workadventure-room-api:latest
    restart: always
    env_file:
      - .env
    environment:
      DOMAIN: ${DOMAIN}
      SECRET_KEY: ${SECRET_KEY}
      PUSHER_URL: ${PUSHER_URL}
      MAP_STORAGE_URL: ${MAP_URL}
    depends_on:
      - pusher
    networks:
      - workadventure-net

  map-storage:
    image: thecodingmachine/workadventure-map-storage:latest
    restart: always
    env_file:
      - .env
    environment:
      BASE_URL: ${MAP_URL}
    volumes:
      - ../../docker-data/map-storage:/var/www/html/maps
    networks:
      - workadventure-net

  coturn:
    image: instrumentisto/coturn:latest
    restart: always
    command:
      - "--no-auth"
      - "--no-cli"
      - "--no-tls"
      - "--no-dtls"
      - "--listening-port=${TURN_PORT}"
      - "--purge"
    ports:
      - "${TURN_PORT}:${TURN_PORT}/udp"
    networks:
      - workadventure-net

  nginx:
    image: nginx:1.25-alpine
    restart: always
    depends_on:
      - play
      - pusher
      - room-api
      - map-storage
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
      - ../../docker-data/nginx/logs:/var/log/nginx
    networks:
      - workadventure-net

networks:
  workadventure-net:
    driver: bridge
